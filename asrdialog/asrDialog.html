<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è¯­éŸ³å¯¹è¯ç³»ç»Ÿ</title>
    <script src="../js/websocket-client.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/prohibit.js"></script>
    <!-- Markdownæ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="./asrDialog.css">
    <style>
        /* ã€æ–°å¢ã€‘ä¸´æ—¶å›¾ç‰‡é¢„è§ˆæ ·å¼ */
        .image-preview-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px;
            max-width: 200px;
        }

        .image-preview-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-preview-overlay img {
            width: 100%;
            height: auto;
            max-height: 150px;
            object-fit: contain;
            border-radius: 4px;
        }

        .preview-label {
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }

        /* æ¶ˆæ¯ä¸­çš„ç¼©ç•¥å›¾æ ·å¼ */
        .message-thumbnail {
            max-width: 100px;
            max-height: 100px;
            border-radius: 4px;
            margin-top: 8px;
            cursor: pointer;
            object-fit: cover;
        }

        /* Markdownæ ·å¼ - åŸºäº22pxåŸºç¡€å­—ä½“ */
        .message-text h1,
        .message-text h2,
        .message-text h3,
        .message-text h4,
        .message-text h5,
        .message-text h6 {
            margin: 12px 0 8px 0;
            font-weight: 600;
            color: inherit;
        }

        .message-text h1 {
            font-size: 1.5em;
        }

        /* 33px */
        .message-text h2 {
            font-size: 1.3em;
        }

        /* 28.6px */
        .message-text h3 {
            font-size: 1.1em;
        }

        /* 24.2px */

        .message-text p {
            margin: 8px 0;
            line-height: 1.6;
            font-size: inherit;
            /* ç»§æ‰¿22px */
        }

        .message-text ul,
        .message-text ol {
            margin: 8px 0;
            padding-left: 24px;
            font-size: inherit;
            /* ç»§æ‰¿22px */
        }

        .message-text li {
            margin: 4px 0;
            line-height: 1.6;
            font-size: inherit;
            /* ç»§æ‰¿22px */
        }

        .message-text code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            /* 19.8px */
        }

        .message-text pre {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .message-text pre code {
            background: none;
            padding: 0;
        }

        .message-text blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            padding-left: 12px;
            margin: 10px 0;
            color: rgba(255, 255, 255, 0.8);
        }

        .message-text strong {
            font-weight: 600;
        }

        .message-text em {
            font-style: italic;
        }

        .message-text a {
            color: #5B9FED;
            text-decoration: none;
        }

        .message-text a:hover {
            text-decoration: underline;
        }

        .message-text table {
            border-collapse: collapse;
            margin: 10px 0;
            width: 100%;
        }

        .message-text table th,
        .message-text table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            text-align: left;
        }

        .message-text table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .message-text hr {
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin: 16px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="header">
            <div class="header-box">
                <img src="../image/qualityControl.png" alt="logo" width="48" height="48">
                <span class="title">æ™ºèƒ½è¯­éŸ³å¯¹è¯</span>
            </div>
            <div class="status-bar">
                <div class="connection-status" id="connectionStatus">
                    <div class="status-dot"></div>
                    <span class="status-text">è¿æ¥ä¸­...</span>
                </div>
                <div class="asr-status" id="asrStatus">
                    <div class="mic-icon">ğŸ¤</div>
                    <span class="asr-text">å‡†å¤‡å¬å–è¯­éŸ³</span>
                </div>
            </div>
        </div>

        <!-- å¯¹è¯æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message system">
                    <div class="message-content">
                        <div class="message-text">æ™ºèƒ½è¯­éŸ³å¯¹è¯ç³»ç»Ÿå·²å¯åŠ¨ï¼Œè¯·å¼€å§‹è¯´è¯ã€‚</div>
                        <div class="message-time">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>
            </div>
            <!-- ã€æ–°å¢ã€‘ä¸´æ—¶å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
            <div class="image-preview-overlay" id="imagePreview" style="display: none;">
                <div class="image-preview-content">
                    <img id="previewImage" src="" alt="æˆªå›¾é¢„è§ˆ">
                    <div class="preview-label">æˆªå›¾é¢„è§ˆ</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
        <div class="input-container">
            <div class="input-wrapper">
                <div class="input-status" id="inputStatus">
                    <div class="status-indicator"></div>
                    <span class="status-label">å‡†å¤‡è¾“å…¥</span>
                </div>
                <div class="input-area" id="inputArea">
                    <div class="input-placeholder" id="inputPlaceholder">è¯·å¼€å§‹è¯´è¯...</div>
                    <div class="input-text" id="inputText"></div>
                </div>
                <div class="input-actions">
                    <button class="btn-clear" id="btnClear" title="æ¸…ç©ºè¾“å…¥">æ¸…ç©º</button>
                    <button class="btn-send" id="btnSend" title="å‘é€æ¶ˆæ¯ï¼ˆæˆ–è¯´" å‘é€"ï¼‰">å‘é€</button>
                </div>
            </div>
            <div class="tips">
                <span>ğŸ’¡ è¯´å‡º"å‘é€"å³å¯è‡ªåŠ¨å‘é€æ¶ˆæ¯</span>
            </div>
        </div>
    </div>

    <script>
        // WebSocketå®¢æˆ·ç«¯è¿æ¥
        const wsClient = createWebSocketClient({
            url: '/',
            enableHandshake: false  // ç¦ç”¨æ¡æ‰‹æœºåˆ¶ï¼Œè¿æ¥æˆåŠŸåç«‹å³è§¦å‘openäº‹ä»¶
        });

        // å…¨å±€å˜é‡
        let isListening = false;
        let currentInput = '';
        let messageHistory = [];
        // ã€æ–°å¢ã€‘å½“å‰ä¸´æ—¶å›¾ç‰‡
        let currentImageBase64 = null;

        // DOMå…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const inputText = document.getElementById('inputText');
        const inputPlaceholder = document.getElementById('inputPlaceholder');
        const inputArea = document.getElementById('inputArea');
        const connectionStatus = document.getElementById('connectionStatus');
        const asrStatus = document.getElementById('asrStatus');
        const inputStatus = document.getElementById('inputStatus');
        const btnClear = document.getElementById('btnClear');
        const btnSend = document.getElementById('btnSend');
        // ã€æ–°å¢ã€‘å›¾ç‰‡é¢„è§ˆå…ƒç´ 
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');

        // è¿æ¥çŠ¶æ€ç®¡ç†
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('.status-dot');
            const statusText = connectionStatus.querySelector('.status-text');

            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'å·²è¿æ¥';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'è¿æ¥æ–­å¼€';
            }
        }

        // ASRçŠ¶æ€ç®¡ç†
        function updateASRStatus(listening, text = 'å‡†å¤‡å¬å–è¯­éŸ³') {
            const micIcon = asrStatus.querySelector('.mic-icon');
            const asrText = asrStatus.querySelector('.asr-text');

            if (listening) {
                micIcon.className = 'mic-icon listening';
                asrText.textContent = text;
                asrStatus.classList.add('listening');
                connectionStatus.classList.add('listening-mode');
            } else {
                micIcon.className = 'mic-icon';
                asrText.textContent = text;
                asrStatus.classList.remove('listening');
                connectionStatus.classList.remove('listening-mode');
            }
        }

        // è¾“å…¥çŠ¶æ€ç®¡ç†
        function updateInputStatus(hasText, isDetected = false) {
            const statusIndicator = inputStatus.querySelector('.status-indicator');
            const statusLabel = inputStatus.querySelector('.status-label');

            if (hasText) {
                statusIndicator.className = 'status-indicator active';
                statusLabel.textContent = isDetected ? 'æ£€æµ‹åˆ°"å‘é€"å…³é”®è¯' : 'æ­£åœ¨è¾“å…¥...';
                inputPlaceholder.style.display = 'none';
                inputText.style.display = 'block';
            } else {
                statusIndicator.className = 'status-indicator';
                statusLabel.textContent = 'å‡†å¤‡è¾“å…¥';
                inputPlaceholder.style.display = 'block';
                inputText.style.display = 'none';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
        function addMessage(text, type = 'user', timestamp = null, imageBase64 = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;

            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = timestamp || new Date().toLocaleTimeString('zh-CN');

            messageContent.appendChild(messageText);

            // ã€æ–°å¢ã€‘å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ ç¼©ç•¥å›¾
            if (imageBase64) {
                const thumbnail = document.createElement('img');
                thumbnail.className = 'message-thumbnail';
                thumbnail.src = imageBase64;
                thumbnail.alt = 'æˆªå›¾';
                thumbnail.title = 'ç‚¹å‡»æŸ¥çœ‹å¤§å›¾';
                thumbnail.onclick = () => {
                    // å¯ä»¥æ·»åŠ æŸ¥çœ‹å¤§å›¾çš„é€»è¾‘
                    window.open(imageBase64, '_blank');
                };
                messageContent.appendChild(thumbnail);
            }

            messageContent.appendChild(messageTime);
            messageDiv.appendChild(messageContent);

            chatMessages.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // ä¿å­˜åˆ°å†å²è®°å½•
            messageHistory.push({
                text: text,
                type: type,
                timestamp: timestamp || new Date().toISOString(),
                imageBase64: imageBase64
            });
        }

        // æ›´æ–°è¾“å…¥æ å†…å®¹
        function updateInput(text, detectedKeyword = false, isRealtime = false, shouldAppend = false) {
            // ã€ä¿®å¤ã€‘æ”¯æŒç´¯åŠ æ¨¡å¼
            if (shouldAppend) {
                currentInput = (currentInput || '') + text;
            } else {
                currentInput = text;
            }
            inputText.innerText = currentInput;  // ä½¿ç”¨innerTextæ”¯æŒæ¢è¡Œæ˜¾ç¤º

            if (text && text.trim()) {
                updateInputStatus(true, detectedKeyword);

                // åº”ç”¨ç›‘å¬çŠ¶æ€æ ·å¼
                inputArea.classList.add('listening-active');

                if (isRealtime) {
                    inputArea.classList.add('realtime-updating');
                    inputText.classList.add('realtime-text');
                    inputText.classList.remove('confirmed-text');
                } else {
                    inputArea.classList.remove('realtime-updating');
                    inputText.classList.add('confirmed-text');
                    inputText.classList.remove('realtime-text');
                }

                if (detectedKeyword) {
                    inputArea.classList.add('keyword-detected');
                } else {
                    inputArea.classList.remove('keyword-detected');
                }
            } else {
                updateInputStatus(false);
                inputArea.classList.remove('keyword-detected');
                inputArea.classList.remove('listening-active');
                inputArea.classList.remove('realtime-updating');
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            // è·å–å½“å‰è¾“å…¥æ çš„å†…å®¹
            const inputContent = currentInput || inputText.textContent || '';
            const hasImage = currentImageBase64 !== null;

            if ((inputContent && inputContent.trim()) || hasImage) {
                const messageText = inputContent ? inputContent.trim() : 'ï¼ˆå›¾ç‰‡ï¼‰';

                // ã€ä¿®å¤ã€‘æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸï¼ŒåŒ…å«å›¾ç‰‡ç¼©ç•¥å›¾
                addMessage(messageText, 'user', null, currentImageBase64);

                // éšè—å›¾ç‰‡é¢„è§ˆ
                if (hasImage) {
                    imagePreview.style.display = 'none';
                    currentImageBase64 = null;
                }

                // ã€ä¿®å¤ã€‘ç«‹å³æ¸…ç©ºè¾“å…¥æ 
                updateInput('');
                currentInput = '';
                updateInputStatus(false);

                // æ›´æ–°ASRçŠ¶æ€
                updateASRStatus(true, 'æ¶ˆæ¯å·²å‘é€ï¼Œç»§ç»­è¯´è¯æˆ–è¯´"å‘é€"...');

                // å‘é€ç¡®è®¤æ¶ˆæ¯åˆ°åç«¯
                sendConfirmToBackend(messageText);

                // æ¨¡æ‹Ÿç³»ç»Ÿå›å¤ï¼ˆå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦è°ƒç”¨AIæ¥å£ï¼‰
                setTimeout(() => {
                    addMessage('æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š' + messageText, 'system');
                }, 500);
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            updateInput('');
            currentInput = '';
            // ã€æ–°å¢ã€‘æ¸…ç©ºå›¾ç‰‡é¢„è§ˆ
            if (currentImageBase64) {
                imagePreview.style.display = 'none';
                currentImageBase64 = null;
            }
        }

        // å‘é€ç¡®è®¤æ¶ˆæ¯åˆ°åç«¯
        function sendConfirmToBackend(messageText) {
            // é€šè¿‡WebSocketå‘é€ç¡®è®¤æ¶ˆæ¯
            if (wsClient && wsClient.socket) {
                const confirmMsg = {
                    messageType: 1012, // WEBSOCKET_MSG_ASR_SEND_CONFIRM
                    message: 'å‘é€æˆåŠŸ',
                    content: messageText,
                    timestamp: new Date().toISOString()
                };
                wsClient.socket.send(JSON.stringify(confirmMsg));
            }
        }

        // ç¼“å†²åŒºçŠ¶æ€ç®¡ç†
        let bufferContent = '';
        let isBufferMode = false;

        // æ›´æ–°ç¼“å†²åŒºå†…å®¹ï¼ˆä¸åŒäºå®æ—¶è¯†åˆ«å†…å®¹ï¼‰
        function updateBuffer(content) {
            bufferContent = content;
            if (content && content.trim()) {
                isBufferMode = true;
                updateInput(content, false, false);
            }
        }

        // å¤„ç†å®æ—¶è¯†åˆ«å†…å®¹
        function handleRealtimeText(text) {
            if (!isBufferMode || !bufferContent) {
                // åªæœ‰åœ¨æ²¡æœ‰ç¼“å†²åŒºå†…å®¹æ—¶æ‰æ˜¾ç¤ºå®æ—¶è¯†åˆ«
                updateInput(text, false, true);
            }
        }

        // WebSocketæ¶ˆæ¯å¤„ç†
        wsClient.on('open', () => {
            updateConnectionStatus(true);
            addMessage('WebSocketè¿æ¥å·²å»ºç«‹', 'system');

            // æ‰‹åŠ¨å‘é€å®¢æˆ·ç«¯ç±»å‹ä¿¡æ¯ç»™åç«¯ï¼Œä»¥ä¾¿åç«¯è¯†åˆ«å¹¶å‘é€æ¶ˆæ¯
            wsClient.send(JSON.stringify({
                "clientType": 1,  // PC_MAIN ä¸»å±å¹•
                "messageType": 0  // æ¡æ‰‹æ¶ˆæ¯ç±»å‹
            }));
        });

        wsClient.on('close', () => {
            updateConnectionStatus(false);
            addMessage('WebSocketè¿æ¥å·²æ–­å¼€', 'system');
        });

        wsClient.on('message', (data) => {
            if (!isJSON(data)) return;

            let result = JSON.parse(data);

            // ã€ä¿®å¤ã€‘è¿‡æ»¤æ¶ˆæ¯ï¼šåªå¤„ç†ASRç›¸å…³çš„æ¶ˆæ¯ç±»å‹
            // 1004-1012: ASRåŸºç¡€æ¶ˆæ¯
            // 2001-2005: Clinical ASR Assistantæ¶ˆæ¯
            const asrMessageTypes = [1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 2001, 2002, 2003, 2004, 2005];
            if (!asrMessageTypes.includes(result.messageType)) {
                // å¿½ç•¥éASRæ¶ˆæ¯ï¼ˆå¦‚èƒƒè´¨æ§æ¶ˆæ¯1001ã€è‚ è´¨æ§æ¶ˆæ¯1002ç­‰ï¼‰
                return;
            }

            // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
            switch (result.messageType) {
                case 1004: // ASRå®æ—¶æ–‡å­—æ¶ˆæ¯ï¼ˆåŒ…æ‹¬å”¤é†’åçš„è¯†åˆ«ï¼‰
                    if (result.transcriptionText) {
                        // âœ¨ ä¿®å¤ï¼šæ”¯æŒ is_final å­—æ®µï¼Œå®ç°ä¸´æ—¶å’Œæœ€ç»ˆç»“æœçš„åŒºåˆ†
                        // is_final=true: æœ€ç»ˆç¡®è®¤çš„æ–‡æœ¬ï¼Œåº”ç”¨ç¡®è®¤æ ·å¼
                        // is_final=false: ä¸´æ—¶è¯†åˆ«ç»“æœï¼Œåº”ç”¨å®æ—¶æ ·å¼
                        const isFinal = result.is_final !== undefined ? result.is_final : true;

                        // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        console.log(`[å‰ç«¯] æ”¶åˆ°ASRæ¶ˆæ¯: text="${result.transcriptionText}", is_final=${isFinal}`);

                        // æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼šä»…å¤„ç†æœ€ç»ˆç»“æœï¼ˆis_final=Trueï¼‰
                        if (isFinal) {
                            updateInput(result.transcriptionText, result.detectedKeyword || false, false, false);
                            updateASRStatus(true, 'è¯†åˆ«å®Œæˆ');
                            console.log(`[å‰ç«¯] å·²æ›´æ–°è¾“å…¥æ¡†: "${result.transcriptionText}"`);
                        } else {
                            // ä¸´æ—¶ç»“æœä¸æ˜¾ç¤º
                            console.log(`[å‰ç«¯] è·³è¿‡ä¸´æ—¶ç»“æœ: "${result.transcriptionText}"`);
                        }
                    }
                    break;

                case 1005: // ASRå‘é€æŒ‡ä»¤æ¶ˆæ¯
                    if (result.command === 'send_message') {
                        sendMessage();
                        updateASRStatus(false, 'æ¶ˆæ¯å·²å‘é€');
                    } else if (result.command === 'clear') {
                        clearInput();
                        updateASRStatus(false, 'è¾“å…¥å·²æ¸…ç©º');
                    }
                    break;

                case 1006: // ASRçŠ¶æ€æ›´æ–°æ¶ˆæ¯
                    if (result.isListening !== undefined) {
                        updateASRStatus(result.isListening, result.statusText || 'å‡†å¤‡å¬å–è¯­éŸ³');
                    }
                    // å¤„ç†å”¤é†’çŠ¶æ€
                    if (result.isAwakened) {
                        // æ›´æ–°è¾“å…¥çŠ¶æ€ä¸º"ç­‰å¾…è¾“å…¥"
                        updateInputStatus(false, false);
                        inputStatus.querySelector('.status-label').textContent = 'ç­‰å¾…è¾“å…¥...';
                        inputStatus.querySelector('.status-indicator').className = 'status-indicator active';
                        // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
                        if (result.message) {
                            addMessage(result.message, 'system');
                        }
                        console.log('[å‰ç«¯] ASRç³»ç»Ÿå·²å”¤é†’ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥');
                    }
                    break;

                case 1007: // ASRå”¤é†’æ¶ˆæ¯
                    if (result.message) {
                        addMessage(result.message, 'system');
                        // ä¸ºå”¤é†’æ¶ˆæ¯æ·»åŠ ç‰¹æ®Šæ ·å¼
                        const lastMessage = chatMessages.lastElementChild;
                        if (lastMessage) {
                            lastMessage.classList.add('wakeup-message');
                        }
                        updateASRStatus(true, 'æ­£åœ¨ç›‘å¬...');
                        updateInputStatus(true, false);
                        // æ¸…ç©ºè¾“å…¥æ¡†å‡†å¤‡æ¥æ”¶æ–°å†…å®¹
                        currentInput = '';
                        inputText.textContent = '';
                    }
                    break;

                case 1008: // ASRç¼“å†²åŒºæ›´æ–°æ¶ˆæ¯
                    if (result.bufferContent) {
                        updateBuffer(result.bufferContent);
                        if (result.sentenceComplete) {
                            updateASRStatus(true, 'ç›‘å¬ä¸­...ä¸€å¥è¯ç»“æŸï¼Œç»§ç»­è¯´æˆ–è¯´"å‘é€"');
                        }
                    }
                    break;

                case 1009: // ASRå®æ—¶è¯†åˆ«æ¶ˆæ¯
                    if (result.realtimeText && result.isPartial) {
                        // æ˜¾ç¤ºä¸´æ—¶è¯†åˆ«å†…å®¹ï¼Œåªåœ¨æ— ç¼“å†²åŒºå†…å®¹æ—¶æ˜¾ç¤º
                        handleRealtimeText(result.realtimeText);
                        updateASRStatus(true, 'æ­£åœ¨è¯†åˆ«...');
                    }
                    break;

                case 1010: // ASRç›‘å¬è¶…æ—¶æ¶ˆæ¯
                    addMessage('ç›‘å¬è¶…æ—¶ï¼Œè¯·é‡æ–°è¯´"æ™“å¾—æ™“å¾—"å”¤é†’', 'system');
                    updateASRStatus(false, 'ç›‘å¬å·²è¶…æ—¶');
                    updateInputStatus(false);
                    break;

                case 1011: // ASRç¼“å†²åŒºæ¸…ç©ºæ¶ˆæ¯
                    if (result.message) {
                        addMessage(result.message, 'system');
                        // é‡ç½®ç¼“å†²åŒºçŠ¶æ€
                        bufferContent = '';
                        isBufferMode = false;
                        updateInput('');
                        currentInput = '';
                    }
                    break;

                case 1012: // ASRå‘é€ç¡®è®¤æ¶ˆæ¯
                    if (result.message) {
                        console.log('åç«¯ç¡®è®¤å‘é€:', result.message);
                    }
                    break;

                // ==================== Clinical ASR Assistant æ–°å¢æ¶ˆæ¯ç±»å‹ ====================

                case 2001: // Clinical ASR: ç¼–è¾‘æ¡†æµå¼æ¨é€æ–‡æœ¬ï¼ˆå¤‡ç”¨ï¼Œå½“å‰ä½¿ç”¨1004ï¼‰
                    // æ³¨æ„ï¼šå½“å‰ ASR å¼•æ“å‘é€çš„æ˜¯ 1004 æ¶ˆæ¯ç±»å‹ï¼Œä½¿ç”¨ transcriptionText å­—æ®µ
                    // æ­¤ case ä¿ç•™ç”¨äºæœªæ¥å¯èƒ½çš„æ‰©å±•
                    if (result.text) {
                        const isFinal = result.is_final !== undefined ? result.is_final : true;
                        updateInput(result.text, false, !isFinal, false);
                        updateASRStatus(true, 'Clinical ASRæ­£åœ¨è¯†åˆ«...');
                    }
                    break;

                case 2002: // Clinical ASR: ç¼–è¾‘æ¡†æ¸…ç©º
                    clearInput();
                    addMessage('Clinical ASRå·²æ¸…ç©ºè¾“å…¥', 'system');
                    break;

                case 2003: // Clinical ASR: ç¼–è¾‘æ¡†æ˜¾ç¤ºå›¾åƒ
                    if (result.image_base64) {
                        // ã€ä¿®å¤ã€‘æ˜¾ç¤ºåœ¨ä¸´æ—¶é¢„è§ˆåŒºåŸŸï¼Œè€Œä¸æ˜¯ç¼–è¾‘æ¡†
                        currentImageBase64 = result.image_base64;
                        previewImage.src = result.image_base64;
                        imagePreview.style.display = 'block';

                        // æ·»åŠ ç³»ç»Ÿæç¤º
                        addMessage(`å·²æˆªå–å›¾åƒï¼ˆ${result.patient_name || 'æœªçŸ¥æ‚£è€…'}ï¼‰ï¼Œè¯´"å‘é€"å³å¯å‘é€`, 'system');
                    }
                    break;

                case 2004: // Clinical ASR: å¯¹è¯æ¡†æ¨é€ç”¨æˆ·æ¶ˆæ¯
                    if (result.content) {
                        // å¤ç”¨ç°æœ‰çš„addMessageå‡½æ•°
                        addMessage(result.content, 'user', result.timestamp);
                    }
                    break;

                case 2005: // Clinical ASR: å¯¹è¯æ¡†æ›´æ–°LLMå›å¤
                    if (result.content && result.message_id) {
                        // æŸ¥æ‰¾æ˜¯å¦å·²å­˜åœ¨è¯¥message_idçš„æ¶ˆæ¯
                        const existingMsg = Array.from(chatMessages.children).find(
                            msg => msg.dataset && msg.dataset.messageId === result.message_id
                        );

                        if (existingMsg) {
                            // æ›´æ–°ç°æœ‰æ¶ˆæ¯
                            const messageText = existingMsg.querySelector('.message-text');
                            if (messageText) {
                                // ä½¿ç”¨markdownæ¸²æŸ“
                                messageText.innerHTML = marked.parse(result.content);
                            }
                        } else {
                            // åˆ›å»ºæ–°çš„AIæ¶ˆæ¯
                            const messageDiv = document.createElement('div');
                            messageDiv.className = 'message assistant';
                            messageDiv.dataset.messageId = result.message_id;

                            const messageContent = document.createElement('div');
                            messageContent.className = 'message-content';

                            const messageText = document.createElement('div');
                            messageText.className = 'message-text';
                            // ä½¿ç”¨markdownæ¸²æŸ“
                            messageText.innerHTML = marked.parse(result.content);

                            const messageTime = document.createElement('div');
                            messageTime.className = 'message-time';
                            messageTime.textContent = result.timestamp
                                ? new Date(result.timestamp).toLocaleTimeString('zh-CN')
                                : new Date().toLocaleTimeString('zh-CN');

                            messageContent.appendChild(messageText);
                            messageContent.appendChild(messageTime);
                            messageDiv.appendChild(messageContent);
                            chatMessages.appendChild(messageDiv);
                        }

                        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                    break;

                // ==================== å…¶ä»–æ¶ˆæ¯ç±»å‹ ====================

                default:
                    // å…¶ä»–æ¶ˆæ¯ç±»å‹çš„å¤„ç†
                    console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', result.messageType, result);
                    break;
            }
        });

        // æŒ‰é’®äº‹ä»¶ç»‘å®š
        btnSend.addEventListener('click', sendMessage);
        btnClear.addEventListener('click', clearInput);

        // é”®ç›˜äº‹ä»¶æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            } else if (e.key === 'Escape') {
                clearInput();
            }
        });

        // åˆå§‹åŒ–
        updateConnectionStatus(false);
        updateASRStatus(false);
        updateInputStatus(false);

    </script>

</body>

</html>